name: Monitor

on:
  schedule:
    # 日本株 10:10 JST = UTC 1:10 (月-金)
    - cron: '10 1 * * 1-5'
    # 日本株 16:00 JST = UTC 7:00 (月-金)
    - cron: '0 7 * * 1-5'
    # 米国株 0:00 JST = UTC 15:00 前日 (日-木 = JST月-金)
    - cron: '0 15 * * 0-4'
    # 米国株 6:30 JST = UTC 21:30 前日 (日-木 = JST月-金)
    - cron: '30 21 * * 0-4'
    # 週末 10:00 JST = UTC 1:00 (土日: 全銘柄一括)
    - cron: '0 1 * * 0,6'
  workflow_dispatch:
    inputs:
      market:
        description: '市場フィルタ（US / JP / 空欄=全銘柄）'
        required: false
        type: string
      ticker:
        description: '特定銘柄のみチェック（空欄=全銘柄）'
        required: false
        type: string
      monitor_only:
        description: '監視のみ（NG時にDiscussion/Planningを起動しない）'
        required: false
        type: boolean
        default: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Setup Python
        run: uv python install 3.12

      - name: Install Monitor dependencies
        working-directory: Monitor/src
        run: uv sync

      - name: Install Discussion dependencies
        working-directory: Discusion/src
        run: uv sync

      - name: Install Planning dependencies
        working-directory: Planning/src
        run: uv sync

      - name: Determine market and frequency from schedule
        id: schedule
        run: |
          DOW_UTC=$(date -u +%u)  # 1=Mon ... 7=Sun
          HOUR_UTC=$(date -u +%H)
          MIN_UTC=$(date -u +%M)

          # market 判定
          if [ -n "${{ inputs.market }}" ]; then
            echo "market=${{ inputs.market }}" >> "$GITHUB_OUTPUT"
          elif [ "$DOW_UTC" = "6" ] || [ "$DOW_UTC" = "7" ]; then
            echo "market=" >> "$GITHUB_OUTPUT"
          elif [ "$HOUR_UTC" = "01" ] || [ "$HOUR_UTC" = "07" ]; then
            echo "market=JP" >> "$GITHUB_OUTPUT"
          elif [ "$HOUR_UTC" = "15" ] || [ "$HOUR_UTC" = "21" ]; then
            echo "market=US" >> "$GITHUB_OUTPUT"
          else
            echo "market=" >> "$GITHUB_OUTPUT"
          fi

          # 2回目の実行（JP 16:00=UTC 07:00, US 6:30=UTC 21:30）は長期をスキップ
          if [ "$HOUR_UTC" = "07" ] || [ "$HOUR_UTC" = "21" ]; then
            echo "skip_span=long" >> "$GITHUB_OUTPUT"
          else
            echo "skip_span=" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Monitor → Discussion → Planning pipeline
        working-directory: Monitor/src
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          ARGS=""
          MARKET="${{ steps.schedule.outputs.market }}"
          SKIP="${{ steps.schedule.outputs.skip_span }}"
          if [ -n "$MARKET" ]; then
            ARGS="$ARGS --market $MARKET"
          fi
          if [ -n "$SKIP" ]; then
            ARGS="$ARGS --skip-span $SKIP"
          fi
          if [ -n "${{ inputs.ticker }}" ]; then
            ARGS="$ARGS --ticker ${{ inputs.ticker }}"
          fi
          if [ "${{ inputs.monitor_only }}" = "true" ]; then
            ARGS="$ARGS --monitor-only"
          fi
          uv run python ng_dispatch.py $ARGS
