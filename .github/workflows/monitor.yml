##
# 定期監視ワークフロー
#
# 保有銘柄の現在価格を plan 策定時の想定価格と比較し、
# 乖離が大きい（NG）銘柄に対して Discussion → Planning パイプラインを起動する。
#
# スケジュール概要（すべて JST 基準）:
#   平日:
#     - JP 10:10 / 16:00  … 東証の寄付後・大引け前の2回
#     - US  0:00 /  6:30  … NY市場の寄付後・引け前の2回
#     ※ 2回目（16:00 / 6:30）は --skip-span long で長期プランのチェックを省略
#   週末:
#     - 土日 10:00 … 全銘柄一括（市場フィルタなし）
#
# パイプライン:
#   ng_dispatch.py が以下を順に実行する
#     1. Monitor  … 各銘柄の現在価格 vs plan 想定価格を比較 → OK/NG 判定
#     2. Discussion（NG時のみ）… Analyst / Devil's Advocate / Judge による多角的議論
#     3. Planning（NG時のみ）… 新 plan の生成・DB 登録
#     4. Discord 通知 … 結果をラベル付き Embed で送信
##
name: Monitor

on:
  schedule:
    # ── 平日 JP（月-金）──
    - cron: '10 1 * * 1-5'   # JP 1回目: 10:10 JST（寄付直後）
    - cron: '0 7 * * 1-5'    # JP 2回目: 16:00 JST（大引け前、long スキップ）
    # ── 平日 US（日-木 = JST 月-金の前日）──
    - cron: '0 15 * * 0-4'   # US 1回目:  0:00 JST（NY 寄付後）
    - cron: '30 21 * * 0-4'  # US 2回目:  6:30 JST（NY 引け前、long スキップ）
    # ── 週末（土日）──
    - cron: '0 1 * * 0,6'    # 全銘柄一括: 10:00 JST
  workflow_dispatch:
    inputs:
      market:
        description: '市場フィルタ（US / JP / 空欄=全銘柄）'
        required: false
        type: string
      ticker:
        description: '特定銘柄のみチェック（空欄=全銘柄）'
        required: false
        type: string
      monitor_only:
        description: '監視のみ（NG時にDiscussion/Planningを起動しない）'
        required: false
        type: boolean
        default: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Setup Python
        run: uv python install 3.12

      - name: Install Monitor dependencies
        working-directory: Monitor/src
        run: uv sync

      - name: Install Discussion dependencies
        working-directory: Discusion/src
        run: uv sync

      - name: Install Planning dependencies
        working-directory: Planning/src
        run: uv sync

      # cron のトリガー時刻（UTC）から market と skip_span を自動判定する。
      # workflow_dispatch で market が指定された場合はそちらを優先。
      # 出力:
      #   market    … "JP" / "US" / ""（全銘柄）
      #   skip_span … "long"（2回目実行時のみ、long-span plan を省略）/ ""
      - name: Determine market and frequency from schedule
        id: schedule
        run: |
          DOW_UTC=$(date -u +%u)  # 1=Mon ... 7=Sun
          HOUR_UTC=$(date -u +%H)
          MIN_UTC=$(date -u +%M)

          # market 判定: 手動入力 > 週末（全銘柄）> 時刻ベース自動判定
          if [ -n "${{ inputs.market }}" ]; then
            echo "market=${{ inputs.market }}" >> "$GITHUB_OUTPUT"
          elif [ "$DOW_UTC" = "6" ] || [ "$DOW_UTC" = "7" ]; then
            echo "market=" >> "$GITHUB_OUTPUT"           # 週末 → 全銘柄
          elif [ "$HOUR_UTC" = "01" ] || [ "$HOUR_UTC" = "07" ]; then
            echo "market=JP" >> "$GITHUB_OUTPUT"          # UTC 01/07 → JP
          elif [ "$HOUR_UTC" = "15" ] || [ "$HOUR_UTC" = "21" ]; then
            echo "market=US" >> "$GITHUB_OUTPUT"          # UTC 15/21 → US
          else
            echo "market=" >> "$GITHUB_OUTPUT"
          fi

          # 各市場の2回目（JP 16:00 / US 6:30）は短期プランだけチェックすれば十分なので
          # long-span を省略してコスト削減する
          if [ "$HOUR_UTC" = "07" ] || [ "$HOUR_UTC" = "21" ]; then
            echo "skip_span=long" >> "$GITHUB_OUTPUT"
          else
            echo "skip_span=" >> "$GITHUB_OUTPUT"
          fi

      # ng_dispatch.py に market / skip_span / ticker / monitor_only を渡してパイプライン実行。
      # --monitor-only を付けると NG 検出しても Discussion/Planning を起動せず監視結果のみ出力。
      - name: Run Monitor → Discussion → Planning pipeline
        working-directory: Monitor/src
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          ARGS=""
          MARKET="${{ steps.schedule.outputs.market }}"
          SKIP="${{ steps.schedule.outputs.skip_span }}"
          if [ -n "$MARKET" ]; then
            ARGS="$ARGS --market $MARKET"
          fi
          if [ -n "$SKIP" ]; then
            ARGS="$ARGS --skip-span $SKIP"
          fi
          if [ -n "${{ inputs.ticker }}" ]; then
            ARGS="$ARGS --ticker ${{ inputs.ticker }}"
          fi
          if [ "${{ inputs.monitor_only }}" = "true" ]; then
            ARGS="$ARGS --monitor-only"
          fi
          uv run python ng_dispatch.py $ARGS
