##
# 経済イベントスケジューラ
#
# FOMC、雇用統計、CPI、決算発表などの経済イベントを取得し、
# DB の event_master / event_watch テーブルに登録する。
# 登録された watch は Event Monitor ワークフローが 5分間隔で期限到来を検知する。
#
# コマンド:
#   seed    … 初期データ投入（年間 + 直近月のイベントを一括登録）
#   annual  … 年間の主要イベントを取得・登録（年1回: 1/2）
#   monthly … 直近 N ヶ月のイベントを取得・登録（月1回: 毎月1日、デフォルト2ヶ月先まで）
#
# スケジュール:
#   - 1月2日 09:00 JST … annual（その年の主要イベントを年初に一括取得）
#   - 毎月1日 09:00 JST … monthly（翌月・翌々月のイベントを補充）
#   ※ 1月は annual と monthly が両方トリガーされるが、
#     1/1 = monthly, 1/2 = annual で日が異なるので重複しない
##
name: EventScheduler

on:
  schedule:
    - cron: '0 0 2 1 *'    # 年次: 1月2日 09:00 JST → annual
    - cron: '0 0 1 * *'    # 月次: 毎月1日 09:00 JST → monthly
  workflow_dispatch:
    inputs:
      command:
        description: '実行コマンド（seed / annual / monthly）'
        required: true
        type: choice
        options:
          - monthly
          - annual
          - seed
        default: monthly
      months:
        description: '月次取得の月数（デフォルト: 2）'
        required: false
        type: string
        default: '2'

jobs:
  scheduler:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Setup Python
        run: uv python install 3.12

      - name: Install EventScheduler dependencies
        working-directory: EventScheduler/src
        run: uv sync

      # cron トリガー時の日付から annual / monthly を自動判定。
      # workflow_dispatch で command が指定された場合はそちらを優先。
      # 出力:
      #   cmd    … "seed" / "annual" / "monthly"
      #   months … annual=12（1年分）, monthly=2（2ヶ月先まで）
      - name: Determine command from schedule
        id: command
        run: |
          if [ -n "${{ inputs.command }}" ]; then
            echo "cmd=${{ inputs.command }}" >> "$GITHUB_OUTPUT"
            echo "months=${{ inputs.months }}" >> "$GITHUB_OUTPUT"
          else
            DAY=$(date -u +%d)
            MONTH=$(date -u +%m)
            if [ "$MONTH" = "01" ] && [ "$DAY" = "02" ]; then
              echo "cmd=annual" >> "$GITHUB_OUTPUT"
              echo "months=12" >> "$GITHUB_OUTPUT"
            else
              echo "cmd=monthly" >> "$GITHUB_OUTPUT"
              echo "months=2" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Run EventScheduler
        working-directory: EventScheduler/src
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          CMD="${{ steps.command.outputs.cmd }}"
          MONTHS="${{ steps.command.outputs.months }}"
          if [ "$CMD" = "seed" ]; then
            uv run python scheduler_orchestrator.py seed
          elif [ "$CMD" = "annual" ]; then
            uv run python scheduler_orchestrator.py annual
          else
            uv run python scheduler_orchestrator.py monthly --months "$MONTHS"
          fi
