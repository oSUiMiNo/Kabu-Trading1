##
# 統合監視ワークフロー（イベント + 定期スケジュール）
#
# 2種類のトリガーを検出し、該当市場の Monitor パイプラインを起動する:
#
#   1. イベント watch … EventScheduler が登録した経済イベント（FOMC, 雇用統計 等）に
#      紐づく event_watch レコードの期限到来を検知
#   2. 定期スケジュール … portfolio_config.monitor_schedules に定義された
#      時刻ベースの定期実行（旧 monitor.yml の cron 相当）
#
# 動作フロー:
#   1. event_watch_check.py  … 上記2種類のトリガーを DB からチェック
#      - 両方該当なし → ジョブ終了（以降のステップはスキップ）
#      - いずれか該当 → 対象市場(markets), skip_spans, event_details を出力
#   2. ng_dispatch.py        … 市場ごとに Monitor → Discussion → Planning パイプラインを実行
#
# スケジュール:
#   5分間隔・24時間稼働。毎時ちょうど (:00) を避けているのは
#   他ワークフローや GitHub 側の負荷集中を避けるため。
##
name: Event Monitor

on:
  schedule:
    - cron: '2,7,12,17,22,27,32,37,42,47,52,57 * * * *'  # 5分間隔（:00 回避）
  workflow_dispatch: {}

jobs:
  event-watch:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # イベント watch + 定期スケジュールを検索。
      # 出力:
      #   has_watches   … "true" / "false"
      #   markets       … スペース区切りの市場リスト（例: "US JP"、空=全銘柄）
      #   skip_spans    … スペース区切り（例: "long"）
      #   event_details … JSON（イベント名・ID 等、Discord 通知用、イベント watch 時のみ）
      # uv を使わず pip で最小依存だけ入れる（watch なしなら即終了なので軽量化）。
      - name: Check for due watches
        id: check
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          pip install postgrest python-dotenv
          python Monitor/src/event_watch_check.py

      # ── 以降は watch ありの場合のみ実行（has_watches == 'true'）──

      - name: Install uv
        if: steps.check.outputs.has_watches == 'true'
        uses: astral-sh/setup-uv@v4

      - name: Setup uv Python
        if: steps.check.outputs.has_watches == 'true'
        run: uv python install 3.12

      - name: Install Monitor dependencies
        if: steps.check.outputs.has_watches == 'true'
        working-directory: Monitor/src
        run: uv sync

      - name: Install Discussion dependencies
        if: steps.check.outputs.has_watches == 'true'
        working-directory: Discusion/src
        run: uv sync

      - name: Install Planning dependencies
        if: steps.check.outputs.has_watches == 'true'
        working-directory: Planning/src
        run: uv sync

      # 対象市場ごとに Monitor パイプラインを実行。
      # イベント watch 由来の場合は EVENT_CONTEXT を渡し、Discord 通知にトリガ名を表示。
      # 定期スケジュール由来の場合は skip_spans を --skip-span 引数として渡す。
      # markets が空の場合は全銘柄チェック（market 引数なし）。
      - name: Run Monitor pipeline for each market
        if: steps.check.outputs.has_watches == 'true'
        working-directory: Monitor/src
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          EVENT_CONTEXT: ${{ steps.check.outputs.event_details }}
        run: |
          MARKETS="${{ steps.check.outputs.markets }}"
          SKIP_SPANS="${{ steps.check.outputs.skip_spans }}"

          SKIP_ARGS=""
          for SPAN in $SKIP_SPANS; do
            SKIP_ARGS="$SKIP_ARGS --skip-span $SPAN"
          done

          if [ -z "$MARKETS" ]; then
            echo "============================================"
            echo "=== Monitor: all markets ==="
            echo "============================================"
            uv run python ng_dispatch.py $SKIP_ARGS
          else
            for MARKET in $MARKETS; do
              echo "============================================"
              echo "=== Monitor: ${MARKET} market ==="
              echo "============================================"
              uv run python ng_dispatch.py --market "$MARKET" $SKIP_ARGS
            done
          fi
