# 投資システム 全体アーキテクチャ

```mermaid
flowchart LR
    %% --- 入力 ---
    USER(["人が銘柄を入力"])
    RESEARCH["調査<br>何の株買うべきか<br>（新規購入候補の調査）"]

    %% --- コアパイプライン ---
    DISC["議論<br>(Discussion)"]
    PLAN["プラン<br>(Planning)"]

    %% --- データ ---
    DB[("DB<br>─────────<br>総投資予算<br>リスク上限<br>保有中の株（銘柄,株数）<br>議論ログ<br>プラン<br>OK or NG")]

    %% --- 監視・実行 ---
    MON["世の中監視"]
    TASK["タスク管理<br>いつ何をするか把握<br>すべきことを通知"]
    OUT(("Out<br>すべき<br>アクション"))

    %% --- フィードバック ---
    EVAL["評価<br>過去データも使って<br>議論エージェントを評価"]
    REEVAL["再議論すべき<br>銘柄を出す"]

    %% ===== メインフロー =====
    RESEARCH --> DISC
    USER --> DISC
    DISC --> |"議論ログ<br>判定結果<br>（買う/買わない/売る/売らない）"| PLAN
    PLAN --> |"全カラム OK"| DB
    MON --> |"OK"| TASK
    TASK --> OUT

    %% ===== プラン → 監視（NG分岐） =====
    PLAN --> |"NG → 銘柄"| MON

    %% ===== DB参照 =====
    DB -.-> |"見る"| MON
    DB -.-> |"見る"| EVAL
    DB -.-> |"見る"| REEVAL

    %% ===== フィードバックループ =====
    EVAL --> DISC
    REEVAL --> DISC

    %% ===== 定期トリガ =====
    TIMER1["① 定期<br>プランがNGぽい銘柄全てに<br>「NG」をつける"]
    TIMER2["② 定期<br>NGが消えて全部OKになるまで<br>5分毎に確認"]

    TIMER1 -.-> DB
    TIMER2 -.-> MON
```

## ノード説明

| ノード | 役割 |
|--------|------|
| **調査** | 新規で買うのに良さげな株を調査する |
| **議論** (Discussion) | 銘柄について買う/売るの議論を行い、判定結果とログを出力 |
| **プラン** (Planning) | 議論の結果を受けて実行可能なプランを作成。資料確認・監視レベル設定・更新時期管理 |
| **DB** | 銘柄ごとのデータを一元管理（予算・リスク・保有状況・ログ・プラン・OK/NGステータス） |
| **世の中監視** | NGの銘柄について市場状況を監視する |
| **タスク管理** | いつ何をすべきか把握し、すべきアクションを通知する |
| **評価** | 過去データも使って議論エージェントの精度を評価し、改善にフィードバック |
| **再議論** | 再議論すべき銘柄を特定して議論に戻す |

## 定期トリガ

| # | トリガ | 内容 |
|---|--------|------|
| ① | 時間で自動 | プランがNGぽい銘柄全てに「NG」をつける |
| ② | 時間で自動 | NGが消えて全部OKになるまで5分毎に確認 |
